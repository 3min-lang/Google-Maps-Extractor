<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Maps 資料爬蟲｜Apify 表單</title>

  <!-- Tailwind（CDN 版，免建置） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['system-ui','Noto Sans TC','ui-sans-serif','-apple-system','Segoe UI','Roboto','Helvetica','Arial'] }
        }
      }
    };
  </script>

  <!-- React + Babel（瀏覽器直接跑 JSX） -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <meta name="color-scheme" content="light only">
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // 簡單的 inline SVG 圖示（取代 lucide-react）
    const Icon = {
      plus:(c="w-5 h-5") => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M12 5v14m7-7H5"/></svg>,
      trash:(c="w-5 h-5") => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M19 7l-1 12a2 2 0 01-2 2H8a2 2 0 01-2-2L5 7m3 0h8M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2"/></svg>,
      send:(c="w-5 h-5")  => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M22 2L11 13"/><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>,
      eye:(c="w-5 h-5")   => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z"/><circle cx="12" cy="12" r="3"/></svg>,
      copy:(c="w-5 h-5")  => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2"/><rect x="8" y="8" width="12" height="12" rx="2"/></svg>,
      check:(c="w-5 h-5") => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7"/></svg>,
      info:(c="w-4 h-4")  => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 22a10 10 0 100-20 10 10 0 000 20z"/></svg>
    };

    function ApifyCrawlerForm() {
      const [formData, setFormData] = useState({
        city: '台北市',
        maxCrawledPlacesPerSearch: 5,     // 直接存數字
        searchStringsArray: [''],
        placeMinimumStars: '',            // '' 或 數字 1-5
        website: 'allPlaces',             // allPlaces | onlyWithWebsite
        searchMatching: 'all'             // all | any | exact
      });
      const [showPreview, setShowPreview] = useState(false);
      const [copied, setCopied] = useState(false);
      const [sending, setSending] = useState(false);
      const [success, setSuccess] = useState(false);

      const taiwanCities = [
        '台北市','新北市','桃園市','台中市','台南市','高雄市',
        '基隆市','新竹市','嘉義市','新竹縣','苗栗縣','彰化縣',
        '南投縣','雲林縣','嘉義縣','屏東縣','宜蘭縣','花蓮縣',
        '台東縣','澎湖縣','金門縣','連江縣'
      ];

      // 產生 Apify JSON（關鍵：型別正確）
      const generateApifyJson = () => {
        const filtered = formData.searchStringsArray.map(s => s.trim()).filter(Boolean);
        return {
          city: formData.city,
          countryCode: "tw",
          language: "zh-TW",
          maxCrawledPlacesPerSearch: Number(formData.maxCrawledPlacesPerSearch) || 5,
          searchStringsArray: filtered,
          skipClosedPlaces: true,
          placeMinimumStars: formData.placeMinimumStars === '' ? '' : Number(formData.placeMinimumStars),
          website: formData.website,            // allPlaces / onlyWithWebsite
          searchMatching: formData.searchMatching
        };
      };

      const addSearchString = () =>
        setFormData(fd => ({ ...fd, searchStringsArray: [...fd.searchStringsArray, ''] }));

      const removeSearchString = (i) =>
        setFormData(fd => {
          const arr = fd.searchStringsArray.filter((_, idx) => idx !== i);
          return { ...fd, searchStringsArray: arr.length ? arr : [''] };
        });

      const updateSearchString = (i, val) =>
        setFormData(fd => {
          const arr = [...fd.searchStringsArray];
          arr[i] = val;
          return { ...fd, searchStringsArray: arr };
        });

      const copyToClipboard = async () => {
        try {
          await navigator.clipboard.writeText(JSON.stringify(generateApifyJson(), null, 2));
          setCopied(true); setTimeout(()=>setCopied(false), 1500);
        } catch { alert('複製失敗，請手動選取。'); }
      };

      const ENDPOINT_N8N = "https://xin03.zeabur.app/webhook/apify001"; // ← 換成你的 n8n Webhook
      const sendToN8N = async () => {
        if (!formData.searchStringsArray.some(s => s.trim())) {
          alert('請至少輸入一個搜尋關鍵字'); return;
        }
        setSending(true); setSuccess(false);
        try {
          const r = await fetch(ENDPOINT_N8N, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(generateApifyJson())
          });
          if (r.ok) { setSuccess(true); setTimeout(()=>setSuccess(false), 4000); }
          else { const t = await r.text(); alert('送出失敗：' + r.status + ' ' + t); }
        } catch(e) { alert('網路錯誤：' + (e?.message || e)); }
        setSending(false);
      };

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-6xl mx-auto px-6 py-4">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-gray-900">Google Maps 資料爬蟲</h1>
                  <p className="text-sm text-gray-600">快速設定並啟動您的資料收集任務</p>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-6xl mx-auto px-6 py-8">
            {success && (
              <div className="mb-8 bg-green-50 border border-green-200 rounded-xl p-4 animate-[fadein_.3s_ease-out]">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                    {Icon.check("w-5 h-5")}
                  </div>
                  <div>
                    <h3 className="text-green-800 font-semibold">任務提交成功！</h3>
                    <p className="text-green-700 text-sm">您的爬蟲任務已開始執行，請稍後查看結果。</p>
                  </div>
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              {/* Main Form */}
              <div className="lg:col-span-2">
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                  <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 border-b border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-900">設定搜尋條件</h2>
                    <p className="text-gray-600 text-sm mt-1">填入您想要爬取的地點和條件</p>
                  </div>

                  <div className="p-8 space-y-8">
                    {/* 城市 */}
                    <div className="space-y-3">
                      <label className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <span className="w-2 h-2 bg-blue-500 rounded-full"></span> 搜尋地區
                      </label>
                      <select
                        value={formData.city}
                        onChange={(e)=>setFormData({...formData, city:e.target.value})}
                        className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white transition-all duration-200 text-lg"
                      >
                        {taiwanCities.map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                    </div>

                    {/* 關鍵字 */}
                    <div className="space-y-3">
                      <label className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span> 搜尋關鍵字 <span className="text-red-500 text-sm">*</span>
                      </label>

                      <div className="space-y-3">
                        {formData.searchStringsArray.map((v, idx) => (
                          <div key={idx} className="flex gap-3">
                            <input
                              type="text"
                              value={v}
                              onChange={(e)=>updateSearchString(idx, e.target.value)}
                              placeholder="例如：保健食品、餐廳、美容院"
                              className="flex-1 px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-green-500 focus:bg-white transition-all duration-200 text-lg"
                            />
                            <button
                              type="button"
                              onClick={()=>removeSearchString(idx)}
                              disabled={formData.searchStringsArray.length===1}
                              className="w-12 h-12 flex items-center justify-center text-red-500 hover:text-red-700 hover:bg-red-50 rounded-xl transition disabled:text-gray-400 disabled:cursor-not-allowed disabled:hover:bg-transparent"
                              title="刪除"
                            >
                              {Icon.trash()}
                            </button>
                          </div>
                        ))}
                      </div>

                      <button type="button" onClick={addSearchString}
                        className="flex items-center gap-2 px-4 py-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition">
                        {Icon.plus()} 新增關鍵字
                      </button>
                    </div>

                    {/* 進階設定 */}
                    <div className="space-y-6">
                      <label className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <span className="w-2 h-2 bg-purple-500 rounded-full"></span> 進階設定
                      </label>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* 每次搜尋最大爬取數量（存數字） */}
                        <div className="space-y-2">
                          <label className="block text-sm font-medium text-gray-700">每次搜尋最大爬取數量</label>
                          <input
                            type="number" min="1" max="500"
                            value={formData.maxCrawledPlacesPerSearch}
                            onChange={(e)=>setFormData({...formData, maxCrawledPlacesPerSearch: Number(e.target.value) })}
                            className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 focus:bg-white transition"
                            placeholder="預設：5"
                          />
                        </div>

                        {/* 最低評分（轉數字或空字串） */}
                        <div className="space-y-2">
                          <label className="block text-sm font-medium text-gray-700">最低評分篩選</label>
                          <select
                            value={formData.placeMinimumStars === '' ? '' : Number(formData.placeMinimumStars)}
                            onChange={(e)=>setFormData({
                              ...formData,
                              placeMinimumStars: e.target.value === '' ? '' : Number(e.target.value)
                            })}
                            className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 focus:bg-white transition"
                          >
                            <option value="">不篩選</option>
                            <option value={1}>⭐ 1 星以上</option>
                            <option value={2}>⭐ 2 星以上</option>
                            <option value={3}>⭐ 3 星以上</option>
                            <option value={4}>⭐ 4 星以上</option>
                            <option value={5}>⭐ 5 星</option>
                          </select>
                        </div>

                        {/* 網站資訊篩選（對齊 allPlaces/onlyWithWebsite） */}
                        <div className="space-y-2">
                          <label className="block text-sm font-medium text-gray-700">網站資訊篩選</label>
                          <select
                            value={formData.website}
                            onChange={(e)=>setFormData({...formData, website:e.target.value})}
                            className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 focus:bg-white transition"
                          >
                            <option value="allPlaces">🌐 所有地點</option>
                            <option value="onlyWithWebsite">✅ 僅有網站的地點</option>
                          </select>
                        </div>

                        {/* 搜尋匹配方式 */}
                        <div className="space-y-2">
                          <label className="block text-sm font-medium text-gray-700">搜尋匹配方式</label>
                          <select
                            value={formData.searchMatching}
                            onChange={(e)=>setFormData({...formData, searchMatching:e.target.value})}
                            className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 focus:bg-white transition"
                          >
                            <option value="all">🔍 全部匹配</option>
                            <option value="any">🧩 任一匹配</option>
                            <option value="exact">🎯 精確匹配</option>
                          </select>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              {/* 右側：動作 + 說明 */}
              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                  <div className="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-900">執行動作</h3>
                  </div>
                  <div className="p-6 space-y-4">
                    <button type="button" onClick={()=>setShowPreview(s=>!s)}
                      className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-xl transition border-2 border-transparent hover:border-gray-200">
                      {Icon.eye()} {showPreview ? '隱藏預覽' : '預覽 JSON'}
                    </button>

                    <button type="button" onClick={copyToClipboard}
                      className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-xl transition border-2 border-transparent hover:border-blue-200">
                      {copied ? Icon.check() : Icon.copy()} {copied ? '已複製！' : '複製 JSON'}
                    </button>

                    <button type="button" onClick={sendToN8N}
                      disabled={sending || !formData.searchStringsArray.some(s=>s.trim())}
                      className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 disabled:from-gray-400 disabled:to-gray-400 text-white rounded-xl transition shadow-lg hover:shadow-xl disabled:cursor-not-allowed">
                      {Icon.send()} {sending ? '執行中…' : '開始爬取'}
                    </button>
                    <div className="text-xs text-gray-500 text-center">點擊「開始爬取」將資料送至 n8n 自動化流程</div>
                  </div>
                </div>

                <div className="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-6 border border-blue-200">
                  <div className="flex items-center gap-3 mb-4">
                    <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white">
                      {Icon.info()}
                    </div>
                    <h3 className="text-lg font-semibold text-blue-900">使用說明</h3>
                  </div>
                  <ul className="space-y-2 text-sm text-blue-800">
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> 選擇台灣地區城市</li>
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> 輸入至少一個搜尋關鍵字</li>
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> （可選）設定進階條件</li>
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> 送出後到後台查看結果</li>
                  </ul>
                </div>
              </div>
            </div>

            {/* JSON 預覽 */}
            {showPreview && (
              <div className="mt-8 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-4 border-b border-gray-200 flex items-center justify-between">
                  <h3 className="text-lg font-semibold text-gray-900">JSON 預覽</h3>
                  <button onClick={copyToClipboard}
                          className="flex items-center gap-2 px-4 py-2 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition">
                    {copied ? Icon.check("w-4 h-4") : Icon.copy("w-4 h-4")} {copied ? '已複製' : '複製'}
                  </button>
                </div>
                <div className="p-8">
                  <pre className="bg-gray-900 text-gray-50 p-6 rounded-xl overflow-auto text-sm leading-relaxed">
{JSON.stringify(generateApifyJson(), null, 2)}
                  </pre>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ApifyCrawlerForm/>);
  </script>

  <style>
    @keyframes fadein { from {opacity:0; transform: translateY(-6px)} to{opacity:1; transform:none} }
    .animate-\[fadein_.3s_ease-out] { animation: fadein .3s ease-out; }
  </style>
</body>
</html>
