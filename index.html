<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Maps 資料爬蟲｜Apify 表單（地名轉英文 + 自訂半徑 Polygon）</title>

  <!-- Tailwind（CDN） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['system-ui','Noto Sans TC','ui-sans-serif','-apple-system','Segoe UI','Roboto','Helvetica','Arial'] }
        }
      }
    };
  </script>

  <!-- React + Babel（瀏覽器直接跑 JSX） -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <meta name="color-scheme" content="light only">
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    // ——— icons ———
    const Icon = {
      plus:(c="w-5 h-5") => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M12 5v14m7-7H5"/></svg>,
      trash:(c="w-5 h-5") => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M19 7l-1 12a2 2 0 01-2 2H8a2 2 0 01-2-2L5 7m3 0h8M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2"/></svg>,
      send:(c="w-5 h-5")  => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M22 2L11 13"/><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>,
      eye:(c="w-5 h-5")   => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z"/><circle cx="12" cy="12" r="3"/></svg>,
      copy:(c="w-5 h-5")  => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2"/><rect x="8" y="8" width="12" height="12" rx="2"/></svg>,
      check:(c="w-5 h-5") => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7"/></svg>,
      info:(c="w-4 h-4")  => <svg className={c} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 22a10 10 0 100-20 10 10 0 000 20z"/></svg>
    };

    // 中文 → 英文 對照
    const TW_CITY_TO_EN = {
      '台北市': 'Taipei City', '新北市': 'New Taipei City', '桃園市': 'Taoyuan City',
      '台中市': 'Taichung City', '台南市': 'Tainan City', '高雄市': 'Kaohsiung City',
      '基隆市': 'Keelung City', '新竹市': 'Hsinchu City', '嘉義市': 'Chiayi City',
      '新竹縣': 'Hsinchu County', '苗栗縣': 'Miaoli County', '彰化縣': 'Changhua County',
      '南投縣': 'Nantou County', '雲林縣': 'Yunlin County', '嘉義縣': 'Chiayi County',
      '屏東縣': 'Pingtung County', '宜蘭縣': 'Yilan County', '花蓮縣': 'Hualien County',
      '台東縣': 'Taitung County', '澎湖縣': 'Penghu County', '金門縣': 'Kinmen County',
      '連江縣': 'Lienchiang County'
    };
    const TAIWAN_CITIES = Object.keys(TW_CITY_TO_EN);

    // 解析 Google Map 複製的 "lat, lng" 字串
    function parseLatLng(input) {
      if (!input) return null;
      const s = String(input).trim().replace(/[，\s]+/g, ','); // 全形逗號/空白 → 逗號
      const [a, b] = s.split(',').map(x => Number(x));
      if (!isFinite(a) || !isFinite(b)) return null;
      // 一般情況：第一個是 lat (-90~90)，第二個是 lng (-180~180)
      let lat = a, lng = b;
      if (Math.abs(a) > 90 || Math.abs(b) > 180) {
        // 可能反了（使用者貼了 "lng, lat"）
        lat = b; lng = a;
      }
      if (Math.abs(lat) > 90 || Math.abs(lng) > 180) return null;
      return { lat, lng };
    }

    // 由中心點 + 半徑（公尺）產生「方形 Polygon」（經度在前、緯度在後；最後一點封口）
    function buildSquarePolygon({ lat, lng }, radiusMeters) {
      const R = 6378137; // 地球半徑（WGS84）
      const dLat = (radiusMeters / R) * (180 / Math.PI);
      const dLng = (radiusMeters / (R * Math.cos((lat * Math.PI) / 180))) * (180 / Math.PI);
      const latMin = lat - dLat, latMax = lat + dLat;
      const lngMin = lng - dLng, lngMax = lng + dLng;

      const ring = [
        [lngMin, latMin],
        [lngMin, latMax],
        [lngMax, latMax],
        [lngMax, latMin],
        [lngMin, latMin], // 封口
      ];
      return {
        type: "Polygon",
        coordinates: [ring],
      };
    }

    function ApifyCrawlerForm() {
      const [formData, setFormData] = useState({
        city: '台北市',
        maxCrawledPlacesPerSearch: 5,
        searchStringsArray: [''],
        // 新增：中心座標（Google Map 直接複製），半徑（公尺）
        centerLatLng: '',
        radius: 1000, // 預設 1000m
      });
      const [showPreview, setShowPreview] = useState(true);
      const [copied, setCopied] = useState(false);
      const [sending, setSending] = useState(false);
      const [success, setSuccess] = useState(false);

      const cityEN = useMemo(() => TW_CITY_TO_EN[formData.city] || formData.city, [formData.city]);
      const parsedCenter = useMemo(() => parseLatLng(formData.centerLatLng), [formData.centerLatLng]);
      const customGeolocation = useMemo(() => {
        if (!parsedCenter || !formData.radius || formData.radius <= 0) return null;
        return buildSquarePolygon(parsedCenter, Number(formData.radius));
      }, [parsedCenter, formData.radius]);

      // 產生 Apify JSON（符合你給的範例結構）
      const generateApifyJson = () => {
        const keywords = formData.searchStringsArray.map(s => s.trim()).filter(Boolean);
        const payload = {
          city: cityEN,
          countryCode: "tw",
          language: "zh-TW",
          maxCrawledPlacesPerSearch: Number(formData.maxCrawledPlacesPerSearch) || 3,
          searchStringsArray: keywords,
          skipClosedPlaces: true,
        };
        if (customGeolocation) payload.customGeolocation = customGeolocation;
        return payload;
      };

      const addSearchString = () =>
        setFormData(fd => ({ ...fd, searchStringsArray: [...fd.searchStringsArray, ''] }));

      const removeSearchString = (i) =>
        setFormData(fd => {
          const arr = fd.searchStringsArray.filter((_, idx) => idx !== i);
          return { ...fd, searchStringsArray: arr.length ? arr : [''] };
        });

      const updateSearchString = (i, val) =>
        setFormData(fd => {
          const arr = [...fd.searchStringsArray];
          arr[i] = val; return { ...fd, searchStringsArray: arr };
        });

      const copyToClipboard = async () => {
        try {
          await navigator.clipboard.writeText(JSON.stringify(generateApifyJson(), null, 2));
          setCopied(true); setTimeout(()=>setCopied(false), 1500);
        } catch { alert('複製失敗，請手動選取。'); }
      };

      const ENDPOINT_N8N = "https://xin03.zeabur.app/webhook/apify001"; // ← 換成你的 n8n Webhook
      const sendToN8N = async () => {
        if (!formData.searchStringsArray.some(s => s.trim())) {
          alert('請至少輸入一個搜尋關鍵字'); return;
        }
        setSending(true); setSuccess(false);
        try {
          const r = await fetch(ENDPOINT_N8N, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(generateApifyJson())
          });
          if (r.ok) { setSuccess(true); setTimeout(()=>setSuccess(false), 4000); }
          else { const t = await r.text(); alert('送出失敗：' + r.status + ' ' + t); }
        } catch(e) { alert('網路錯誤：' + (e?.message || e)); }
        setSending(false);
      };

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-6xl mx-auto px-6 py-4">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-gray-900">Google Maps 資料爬蟲</h1>
                  <p className="text-sm text-gray-600">地名自動轉英文＋自訂半徑 Polygon</p>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-6xl mx-auto px-6 py-8">
            {success && (
              <div className="mb-8 bg-green-50 border border-green-200 rounded-xl p-4 animate-[fadein_.3s_ease-out]">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                    {Icon.check("w-5 h-5")}
                  </div>
                  <div>
                    <h3 className="text-green-800 font-semibold">任務提交成功！</h3>
                    <p className="text-green-700 text-sm">您的爬蟲任務已開始執行，請稍後查看結果。</p>
                  </div>
                </div>
              </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              {/* Main Form */}
              <div className="lg:col-span-2">
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                  <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 border-b border-gray-200">
                    <h2 className="text-xl font-semibold text-gray-900">設定搜尋條件</h2>
                    <p className="text-gray-600 text-sm mt-1">填入地點與條件，系統會輸出 Apify 所需 JSON</p>
                  </div>

                  <div className="p-8 space-y-8">
                    {/* 城市（中文選 → 英文輸出） */}
                    <div className="space-y-2">
                      <label className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <span className="w-2 h-2 bg-blue-500 rounded-full"></span> 搜尋地區
                      </label>
                      <select
                        value={formData.city}
                        onChange={(e)=>setFormData({...formData, city:e.target.value})}
                        className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:bg-white transition-all duration-200 text-lg"
                      >
                        {TAIWAN_CITIES.map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                      <p className="text-xs text-gray-500">將輸出英文地名：<span className="font-semibold text-gray-700">{cityEN}</span></p>
                    </div>

                    {/* 關鍵字 */}
                    <div className="space-y-3">
                      <label className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <span className="w-2 h-2 bg-green-500 rounded-full"></span> 搜尋關鍵字 <span className="text-red-500 text-sm">*</span>
                      </label>
                      <div className="space-y-3">
                        {formData.searchStringsArray.map((v, idx) => (
                          <div key={idx} className="flex gap-3">
                            <input
                              type="text"
                              value={v}
                              onChange={(e)=>updateSearchString(idx, e.target.value)}
                              placeholder="例如：餐廳、美容院、保健食品"
                              className="flex-1 px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-green-500 focus:bg-white transition-all duration-200 text-lg"
                            />
                            <button
                              type="button"
                              onClick={()=>removeSearchString(idx)}
                              disabled={formData.searchStringsArray.length===1}
                              className="w-12 h-12 flex items-center justify-center text-red-500 hover:text-red-700 hover:bg-red-50 rounded-xl transition disabled:text-gray-400 disabled:cursor-not-allowed disabled:hover:bg-transparent"
                              title="刪除"
                            >
                              {Icon.trash()}
                            </button>
                          </div>
                        ))}
                      </div>
                      <button type="button" onClick={addSearchString}
                        className="flex items-center gap-2 px-4 py-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition">
                        {Icon.plus()} 新增關鍵字
                      </button>
                    </div>

                    {/* 自訂地理範圍（中心經緯度 + 半徑） */}
                    <div className="space-y-4">
                      <label className="flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <span className="w-2 h-2 bg-purple-500 rounded-full"></span> 地理範圍（可選）
                      </label>

                      <div className="space-y-2">
                        <label className="block text-sm font-medium text-gray-700">中心經緯度（Google 地圖直接複製）</label>
                        <input
                          type="text"
                          value={formData.centerLatLng}
                          onChange={(e)=>setFormData({...formData, centerLatLng: e.target.value})}
                          placeholder="例：25.08462713088979, 121.54978200125787（先緯度、後經度）"
                          className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 focus:bg-white transition"
                        />
                        <p className="text-xs text-gray-500">
                          將自動轉為 Polygon（<b>[經度, 緯度]</b> 順序）。目前解析：
                          <span className="ml-1 font-mono">
                            {parsedCenter ? `${parsedCenter.lat.toFixed(6)}, ${parsedCenter.lng.toFixed(6)}` : '—'}
                          </span>
                        </p>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                        <div className="space-y-2">
                          <label className="block text-sm font-medium text-gray-700">半徑（公尺）</label>
                          <input
                            type="range" min="100" max="50000" step="100"
                            value={formData.radius}
                            onChange={(e)=>setFormData({...formData, radius: Number(e.target.value)})}
                            className="w-full accent-purple-500"
                          />
                        </div>
                        <div className="space-y-2">
                          <label className="block text-sm font-medium text-gray-700">數值微調</label>
                          <input
                            type="number" min="100" max="50000" step="50"
                            value={formData.radius}
                            onChange={(e)=>setFormData({...formData, radius: Number(e.target.value)})}
                            className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 focus:bg-white transition"
                          />
                        </div>
                      </div>

                      {customGeolocation && (
                        <div className="text-xs text-gray-600">
                          已建立 Polygon：共 <b>{customGeolocation.coordinates[0].length}</b> 點（含封口），
                          角落示例（[經度, 緯度]）：<span className="font-mono">
                            {JSON.stringify(customGeolocation.coordinates[0][0])}
                          </span>
                        </div>
                      )}
                    </div>

                    {/* 最大爬取數量 */}
                    <div className="space-y-2">
                      <label className="block text-sm font-medium text-gray-700">每次搜尋最大爬取數量</label>
                      <input
                        type="number" min="1" max="500"
                        value={formData.maxCrawledPlacesPerSearch}
                        onChange={(e)=>setFormData({...formData, maxCrawledPlacesPerSearch: Number(e.target.value) })}
                        className="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:bg-white transition"
                        placeholder="預設：5"
                      />
                    </div>
                  </div>
                </div>
              </div>

              {/* 右側：動作 + 說明 */}
              <div className="space-y-6">
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                  <div className="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-900">執行動作</h3>
                  </div>
                  <div className="p-6 space-y-4">
                    <button type="button" onClick={()=>setShowPreview(s=>!s)}
                      className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-xl transition border-2 border-transparent hover:border-gray-200">
                      {Icon.eye()} {showPreview ? '隱藏預覽' : '預覽 JSON'}
                    </button>

                    <button type="button" onClick={async()=>{
                      try{
                        await navigator.clipboard.writeText(JSON.stringify(generateApifyJson(), null, 2));
                        setCopied(true); setTimeout(()=>setCopied(false), 1500);
                      }catch{ alert('複製失敗，請手動選取。'); }
                    }}
                      className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-xl transition border-2 border-transparent hover:border-blue-200">
                      {copied ? Icon.check() : Icon.copy()} {copied ? '已複製！' : '複製 JSON'}
                    </button>

                    <button type="button" onClick={sendToN8N}
                      disabled={sending || !formData.searchStringsArray.some(s=>s.trim())}
                      className="w-full flex items-center justify-center gap-3 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 disabled:from-gray-400 disabled:to-gray-400 text-white rounded-xl transition shadow-lg hover:shadow-xl disabled:cursor-not-allowed">
                      {Icon.send()} {sending ? '執行中…' : '開始爬取'}
                    </button>
                    <div className="text-xs text-gray-500 text-center">點擊「開始爬取」將資料送至 n8n 自動化流程</div>
                  </div>
                </div>

                <div className="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-6 border border-blue-200">
                  <div className="flex items-center gap-3 mb-4">
                    <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white">
                      {Icon.info()}
                    </div>
                    <h3 className="text-lg font-semibold text-blue-900">使用說明</h3>
                  </div>
                  <ul className="space-y-2 text-sm text-blue-800">
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> 選擇台灣地區城市（中文），系統會輸出英文地名</li>
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> 輸入至少一個搜尋關鍵字</li>
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> （可選）貼上 Google Map 經緯度並拖動半徑 → 自動產生 Polygon</li>
                    <li className="flex items-start gap-2"><span className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2"></span> 送出後到 Apify/n8n 後台查看結果</li>
                  </ul>
                </div>
              </div>
            </div>

            {/* JSON 預覽 */}
            {showPreview && (
              <div className="mt-8 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-4 border-b border-gray-200 flex items-center justify-between">
                  <h3 className="text-lg font-semibold text-gray-900">JSON 預覽</h3>
                  <button onClick={async()=>{
                    try{ await navigator.clipboard.writeText(JSON.stringify(generateApifyJson(), null, 2));
                      setCopied(true); setTimeout(()=>setCopied(false), 1500);
                    }catch{ alert('複製失敗，請手動選取。'); }
                  }}
                          className="flex items-center gap-2 px-4 py-2 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition">
                    {copied ? Icon.check("w-4 h-4") : Icon.copy("w-4 h-4")} {copied ? '已複製' : '複製'}
                  </button>
                </div>
                <div className="p-8">
                  <pre className="bg-gray-900 text-gray-50 p-6 rounded-xl overflow-auto text-sm leading-relaxed">
{JSON.stringify(generateApifyJson(), null, 2)}
                  </pre>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ApifyCrawlerForm/>);
  </script>

  <style>
    @keyframes fadein { from {opacity:0; transform: translateY(-6px)} to{opacity:1; transform:none} }
    .animate-\[fadein_.3s_ease-out] { animation: fadein .3s ease-out; }
  </style>
</body>
</html>
